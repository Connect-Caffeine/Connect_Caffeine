<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
     layout:decorate="~{include/layout}">
 <th:block layout:fragment="content">
<link href="/bootstrap/chat/chat.css" rel="stylesheet">
  <main id="main" class="main">
    <div class="pagetitle">
      <h1>채팅</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item active">목록</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->
    
      
      <section class="section">
          <div class="row">
              <div class="col-md-6">
                  <div class="card">
                      <div class="card-header">
                          <div class="media d-flex align-items-center">
                              <div class="avatar me-3">
                                  
                                  <span class="avatar-status bg-success"></span>
                              </div>
                              <div class="name flex-grow-1">
                                  <h6 class="mb-0" th:text="${roomResult.room_name}"></h6>
                                  
                              </div>
                              <button class="btn btn-sm">
                                  <i data-feather="x"></i>
                              </button>
                          </div>
                      </div>
                      <div class="card-body pt-4 bg-grey" th:each="chatMessage : ${msgResult}">
                           <div class="chat-content" id="chat-container">
                              <div class="chat">
                                  <div class="chat-body">
                                      <div class="chat-message" 
                                      th:if="${chatMessage.emp_code == #authentication.principal.dto.emp_code}"
                                      th:text="${chatMessage.message_content}"></div>
                                  </div>
                              </div>
                          		
                              <div class="chat chat-left" th:if="${chatMessage.emp_code != #authentication.principal.dto.emp_code}">
                                  	  <span th:text="${chatMessage.emp_name}"></span>
                                  <div class="chat-body">
                                      <div class="chat-message"
                                      th:text="${chatMessage.message_content}"></div>
                                  </div>
                              </div>
                          </div>
                              	  <input type="hidden" id="room_no" name="room_no" th:value="${chatMessage.room_no}">
                      </div>
                      <div class="card-footer">
                          <div class="message-form d-flex flex-direction-column align-items-center">
                              <a href="http://" class="black"><i data-feather="smile"></i></a>
                              <div class="d-flex flex-grow-1 ml-4">
                              	  <input type="hidden" id="emp_code" name="emp_code" th:value="${#authentication.principal.dto.emp_code}">
                                  <input type="text" id="txt_msg" class="form-control" placeholder="메세지를 입력하세요.">
                                  <input type="button" class="btn btn-primary rounded-pill" id="send_btn" value="보내기">
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </section>
      <script type="text/javascript">
    let websocket;

    // WebSocket을 열고 연결이 완료되면 메시지를 전송하는 함수
    function connectAndSendMessage(msg) {
        // WebSocket 객체를 새로 생성하고 연결 시도
        websocket = new WebSocket("ws://localhost:8100/chatting");

        // WebSocket 연결이 열렸을 때 실행될 이벤트
        websocket.onopen = () => {
            console.log("WebSocket 연결 성공");
            const obj = setMsgObj('msg', msg);
            websocket.send(JSON.stringify(obj));
            document.getElementById('txt_msg').value = "";
        };

        // WebSocket 메시지를 수신했을 때 실행될 이벤트
        websocket.onmessage = (response) => {
    		const resp = JSON.parse(response.data);
    		if (resp.res_code == '200') {
        		const roomNo = document.getElementById("room_no").value;
        		if (roomNo == resp.room_no) {
            		printMsg(resp.message_content);
        			}
    			}else {
        			alert(resp.res_msg);
    				}
				};


        // WebSocket 연결이 닫혔을 때 실행될 이벤트
        websocket.onclose = () => {
            console.log("WebSocket connection closed");
        };

        // WebSocket 연결에서 오류가 발생했을 때 실행될 이벤트
        websocket.onerror = (error) => {
            console.error("WebSocket 오류 발생:", error);
            alert("WebSocket 오류가 발생했습니다.");
        };
    }

    	// 메시지를 화면에 출력하는 함수
    	const printMsg = function(msg) {
    	const div = document.createElement("div");
    	const textNode = document.createTextNode(msg);
    	div.appendChild(textNode);
    	div.className += 'chat-message'; // 메시지 스타일 설정
    	document.getElementById("chat-container").appendChild(div);

    	// 새로운 메시지로 스크롤 이동
    	document.getElementById("chat-container").scrollTop = document.getElementById("chat-container").scrollHeight;
	};


    // 메시지 전송 버튼 클릭 이벤트
    document.getElementById('send_btn').addEventListener('click', function () {
        const msg = document.getElementById('txt_msg').value;
        if (msg.trim() === "") {
            alert("메시지를 입력하세요.");
            return;
        }

        // WebSocket이 열려 있는 경우 바로 메시지를 전송
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            const obj = setMsgObj('msg', msg);
            websocket.send(JSON.stringify(obj));
            document.getElementById('txt_msg').value = "";
        } else {
            // WebSocket이 닫혀 있는 경우 새로 연결하고 메시지를 전송
            connectAndSendMessage(msg);
        }
    });

    // 메시지 객체를 생성하는 함수
    let setMsgObj = function (chatType, chatMsg) {
        const empCode = document.getElementById("emp_code").value;
        const roomNo = document.getElementById("room_no").value;
        const obj = {
            chat_type: chatType,
            message_content: chatMsg,
            emp_code: empCode,
            room_no: roomNo
        };
        return obj;
    }
</script>

  </main>

</th:block>

</html>
